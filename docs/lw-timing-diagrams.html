<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LW 指令时序图</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: #fff;
        }
        h1, h2 {
            color: #333;
            border-bottom: 2px solid #4a90d9;
            padding-bottom: 10px;
        }
        .diagram-container {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .mermaid {
            display: flex;
            justify-content: center;
        }
        .print-hint {
            background: #e8f4fd;
            border-left: 4px solid #4a90d9;
            padding: 15px;
            margin: 20px 0;
        }
        @media print {
            .print-hint { display: none; }
            .diagram-container { 
                page-break-inside: avoid;
                border: none;
                box-shadow: none;
            }
        }
    </style>
</head>
<body>
    <h1>LW 指令完整执行时序图</h1>
    
    <div class="print-hint">
        <strong>保存为 PDF：</strong>按 <code>Ctrl+P</code>（或 <code>Cmd+P</code>），选择"另存为 PDF"<br>
        <strong>保存为 PNG：</strong>右键点击图表 → "另存图片为..."
    </div>

    <h2>1. 主时序图（ICache 命中场景）</h2>
    <div class="diagram-container">
        <pre class="mermaid">
sequenceDiagram
    autonumber
    participant TOP as TopModule
    participant IC as ICache
    participant EXU as EXU
    participant RF as RegisterFile
    participant LSU as LSU_AXI
    participant ARB as Arbiter
    participant MEM as Memory/SoC

    Note over TOP: PC = 0x30000010

    rect rgb(200, 230, 255)
    Note over TOP,IC: 阶段1: 取指 (Fetch) - ICache命中
    TOP->>IC: cpu_req=1, cpu_addr=0x30000010
    Note over IC: state: IDLE -> LOOKUP
    IC->>IC: 检查 Tag[31:11], Index[10:2]
    Note over IC: hit_way0 或 hit_way1 = 1
    IC-->>TOP: cpu_rvalid=1, cpu_rdata=0x00852303
    Note over IC: state: LOOKUP -> IDLE
    TOP->>TOP: op_ifu=0x00852303, op_en_ifu=1
    end

    rect rgb(255, 230, 200)
    Note over EXU,RF: 阶段2: 译码 (Decode)
    TOP->>EXU: op=0x00852303, op_en=1
    Note over EXU: state: IDLE -> DECODE
    EXU->>EXU: 解析指令字段
    Note over EXU: opcode=0000011 (Load), rd=x6, rs1=x10, imm=8
    EXU->>RF: raddr1=10
    RF-->>EXU: rdata1=0x80000000 (x10的值)
    end

    rect rgb(200, 255, 200)
    Note over EXU,LSU: 阶段3: 执行 + 发起访存 (Execute)
    Note over EXU: state: DECODE -> EXECUTE
    EXU->>EXU: lsu_addr = 0x80000000 + 8 = 0x80000008
    EXU->>LSU: lsu_req=1, lsu_wen=0, lsu_addr=0x80000008
    Note over EXU: state: EXECUTE -> WAIT_LSU
    end

    rect rgb(255, 255, 200)
    Note over LSU,MEM: 阶段4: LSU访存 (Memory Access)
    LSU->>ARB: arvalid=1, araddr=0x80000008
    Note over ARB: state: IDLE -> ARB_LSU
    ARB->>MEM: s_arvalid=1, s_araddr=0x80000008
    MEM-->>ARB: s_arready=1
    Note over MEM: 读取PSRAM数据 (~180周期)
    MEM-->>ARB: s_rvalid=1, s_rdata=0xDEADBEEF
    ARB-->>LSU: m1_rvalid=1, m1_rdata=0xDEADBEEF
    Note over ARB: state: ARB_LSU -> IDLE
    LSU-->>EXU: lsu_rvalid=1, lsu_rdata=0xDEADBEEF
    end

    rect rgb(255, 200, 255)
    Note over EXU,RF: 阶段5: 写回 (Writeback)
    Note over EXU: state: WAIT_LSU -> WRITEBACK
    EXU->>EXU: wdata = lsu_rdata = 0xDEADBEEF
    EXU->>RF: wen=1, waddr=6, wdata=0xDEADBEEF
    Note over RF: x6 = 0xDEADBEEF
    EXU->>EXU: ex_end翻转
    Note over EXU: state: WRITEBACK -> IDLE
    end

    rect rgb(230, 230, 230)
    Note over TOP: 阶段6: PC更新
    EXU-->>TOP: ex_end变化, next_pc=0x30000014
    TOP->>TOP: pc = 0x30000014
    Note over TOP: 准备取下一条指令
    end
        </pre>
    </div>

    <h2>2. ICache 未命中场景时序图</h2>
    <div class="diagram-container">
        <pre class="mermaid">
sequenceDiagram
    autonumber
    participant TOP as TopModule
    participant IC as ICache
    participant IFU as IFU_AXI
    participant ARB as Arbiter
    participant MEM as Memory/SoC

    Note over TOP: PC = 0x30000010 (首次访问)

    rect rgb(200, 230, 255)
    Note over TOP,MEM: 阶段1: 取指 (Fetch) - ICache未命中
    TOP->>IC: cpu_req=1, cpu_addr=0x30000010
    Note over IC: state: IDLE -> LOOKUP
    IC->>IC: 检查缓存
    Note over IC: cache_hit = 0 (miss!)
    Note over IC: state: LOOKUP -> REFILL
    IC->>IFU: mem_req=1, mem_addr=0x30000010
    IFU->>ARB: arvalid=1, araddr=0x30000010
    Note over ARB: state: IDLE -> ARB_IFU
    ARB->>MEM: s_arvalid=1, s_araddr=0x30000010
    MEM-->>ARB: s_arready=1
    Note over MEM: 从Flash XIP读取 (~750周期)
    MEM-->>ARB: s_rvalid=1, s_rdata=0x00852303
    ARB-->>IFU: m0_rvalid=1, m0_rdata=0x00852303
    Note over ARB: state: ARB_IFU -> IDLE
    IFU-->>IC: mem_rvalid=1, mem_rdata=0x00852303
    Note over IC: 更新Cache并返回数据
    Note over IC: state: REFILL -> IDLE
    IC-->>TOP: cpu_rvalid=1, cpu_rdata=0x00852303
    TOP->>TOP: op_ifu=0x00852303, op_en_ifu=1
    end
        </pre>
    </div>

    <h2>3. EXU 状态机（LW指令执行路径）</h2>
    <div class="diagram-container">
        <pre class="mermaid">
stateDiagram-v2
    direction LR
    
    [*] --> IDLE: reset
    IDLE --> DECODE: op_en=1
    DECODE --> EXECUTE: 译码完成
    EXECUTE --> WAIT_LSU: Load/Store指令
    WAIT_LSU --> WRITEBACK: lsu_rvalid=1
    WRITEBACK --> IDLE: 写回完成
        </pre>
    </div>

    <h2>4. ICache 状态机</h2>
    <div class="diagram-container">
        <pre class="mermaid">
stateDiagram-v2
    [*] --> S_IDLE: reset
    
    S_IDLE --> S_LOOKUP: cpu_req=1
    
    S_LOOKUP --> S_IDLE: cache_hit=1
    
    S_LOOKUP --> S_REFILL: cache_hit=0
    
    S_REFILL --> S_IDLE: mem_rvalid=1
        </pre>
    </div>

    <h2>5. IFU_AXI 状态机</h2>
    <div class="diagram-container">
        <pre class="mermaid">
stateDiagram-v2
    [*] --> IFU_IDLE: reset
    
    IFU_IDLE --> IFU_WAIT_AR: req=1
    
    IFU_WAIT_AR --> IFU_WAIT_R: arready=1
    
    IFU_WAIT_R --> IFU_IDLE: rvalid=1
        </pre>
    </div>

    <h2>6. Arbiter 状态机</h2>
    <div class="diagram-container">
        <pre class="mermaid">
stateDiagram-v2
    [*] --> ARB_IDLE: reset
    
    ARB_IDLE --> ARB_IFU: ifu_req=1
    
    ARB_IDLE --> ARB_LSU: lsu_req=1 且 ifu_req=0
    
    ARB_IFU --> ARB_IDLE: 事务完成
    
    ARB_LSU --> ARB_IDLE: 事务完成
        </pre>
    </div>

    <h2>7. AXI4-Lite 读事务时序</h2>
    <div class="diagram-container">
        <pre class="mermaid">
sequenceDiagram
    participant LSU as LSU_AXI
    participant ARB as Arbiter
    participant SoC as ysyxSoC
    
    Note over LSU,SoC: AXI4-Lite 读事务
    
    rect rgb(255, 240, 200)
    Note over LSU,SoC: AR通道 (读地址)
    LSU->>ARB: arvalid=1
    LSU->>ARB: araddr=0x80000008
    ARB->>SoC: s_arvalid=1, s_araddr=0x80000008
    SoC-->>ARB: s_arready=1
    Note over ARB: 地址握手完成
    ARB-->>LSU: m1_arready=1
    LSU->>ARB: arvalid=0
    end
    
    rect rgb(200, 255, 200)
    Note over LSU,SoC: R通道 (读数据)
    LSU->>ARB: rready=1
    Note over SoC: 读取PSRAM (~180周期)
    SoC-->>ARB: s_rvalid=1
    SoC-->>ARB: s_rdata=0xDEADBEEF
    ARB-->>LSU: m1_rvalid=1, m1_rdata
    Note over LSU: 数据握手完成
    LSU->>ARB: rready=0
    end
        </pre>
    </div>

    <script>
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            securityLevel: 'loose',
            sequence: {
                diagramMarginX: 50,
                diagramMarginY: 10,
                actorMargin: 50,
                width: 150,
                height: 65,
                boxMargin: 10,
                boxTextMargin: 5,
                noteMargin: 10,
                messageMargin: 35,
                mirrorActors: true,
                bottomMarginAdj: 1,
                useMaxWidth: true
            }
        });
    </script>
</body>
</html>
