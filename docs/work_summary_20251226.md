# ysyx-workbench 开发与集成阶段性总结报告

**日期**：2025年12月26日
**目标**：完成 NPC 与 ysyxSoC 的深度集成，修复访存 Bug，解决串口输出异常及延迟问题。

---

## 1. 硬件架构重构与修复 (Hardware)

### 1.1 模块重命名与语义对齐
为了消除歧义（避免误认为 AXI 接口模块是存储器本身），进行了以下重命名：
- `IFU_SRAM.v` -> **`IFU_AXI.v`**
- `LSU_SRAM.v` -> **`LSU_AXI.v`**
- 同步更新了模块内部定义、顶层实例化（`ysyx_00000000.v`）以及 `ctags` 索引。

### 1.2 修复 LSU AXI 握手逻辑 (核心修复)
**问题**：原代码在 `req` 有效期间会重复触发 `valid` 信号，导致串口输出字符重复（如 `HHHHoooo`）。
**改进**：
- 引入了严格的状态管理：仅在 `IDLE` 状态下接受新请求。
- **数据对齐**：实现了基于地址低位（`addr[1:0]`）的读数据对齐逻辑，确保 `lbu` 指令能正确读取 `LSR` 等非对齐寄存器。
- **稳定性**：确保在 AXI 事务进行期间地址和控制信号保持稳定。

### 1.3 修复 UART APB 桥接时序
**问题**：APB 读使能信号在 Setup 阶段就撤销，导致数据采样不稳或读出为 0。
**改进**：修改 `uart_top_apb.v`，确保 `reg_re` 和 `reg_we` 在 Access 阶段（`penable=1`）保持有效。

### 1.4 消除仿真输出延迟 (性能优化)
**问题**：UART 硬件模型模拟了真实的波特率，导致仿真时每个字符输出延迟约 0.45 秒。
**改进**：修改 `uart_regs.v`，在仿真环境下强制 `LSR` 的 `THRE` (bit 5) 和 `TEMT` (bit 6) 永远为 1。
**结果**：串口输出速度从 "挤牙膏" 变为 "全速灌入"，长字符串输出时间从数秒缩短至几毫秒。

---

## 2. 软件环境完善 (Software/AM)

### 2.1 运行时环境 (TRM) 增强
- **Bootloader 实现**：在 `_trm_init` 中添加了数据段搬运（MROM -> SRAM）和 BSS 段清零逻辑，支持全局变量写入。
- **数学库支持**：手动实现了 `__udivsi3`, `__umodsi3`, `__mulsi3` 辅助函数，解决了 RV32E 架构下 `printf` 链接失败的问题。
- **串口初始化**：正确配置了 UART16550 的除数寄存器（DLL/DLM）和 LCR 格式。

### 2.2 镜像加载优化
针对 `objcopy` 生成带巨大空洞（285MB）的二进制镜像问题，修改了仿真器 `npc/csrc/memory.cpp`：
- 增加了 `fseek` 逻辑，自动检测并跳过 SRAM 与 MROM 之间的地址空洞。
- **结果**：大镜像现在可以正常、快速地加载到 MROM 中运行。

---

## 3. 测试与验证 (Verification)

### 3.1 关键测试用例
- **`dummy`**: 验证了最基础的启动流。
- **`mem-test`**: 验证了 AXI 总线对 SRAM 的大范围读写能力。
- **`global-var-test`**: 验证了 Bootloader 数据搬运和全局变量的可写性。
- **`hello` (长字符串)**：验证了串口输出的完整性、正确性（无重复）以及高性能（无延迟）。

### 3.2 性能表现
| 优化前 | 优化后 |
| :--- | :--- |
| 字符重复 (Multiple Writes) | 字符唯一 (Strict Handshake) |
| 输出延迟 (~0.45s/char) | 瞬时输出 (<0.0001s/char) |
| 链接失败 (Missing Math) | 成功支持 `printf` 类函数 |

---

## 4. 下一步建议

1. **接口升级**：目前 AXI 仍为 AXI4-Lite，后续可根据性能需求升级为支持 Burst 的完整 AXI4。
2. **外设扩展**：已打通总线逻辑，可以开始在 `perip/` 目录下填充 GPIO、PS/2 和 VGA 的逻辑。
3. **性能跑分**：建议运行 `CoreMark` 评估当前 SoC 的综合性能。

---
*由 Gemini CLI 自动生成*
